# status-queue

status-queue is a combination web service and worker tool for store-and-forward
of Buildkite Build Finished events, and later application of them into a GitHub
Status on a GitHub Enterprise instance.

If you are unwilling or unable to grant the Buildkite service connectivity to
your GitHub Enterprise instance through an HTTP Proxy, status-queue implements a
potential solution for transforming Build Finished events into GitHub Commit
Statuses.

## status-queue is an experimental project üßë‚Äçüî¨üß™‚öóÔ∏è

As an experimental project, the project may be archived in the future. Long term
support is not guaranteed. There is no roadmap of or scheduled work for this
project.

## status-queue is an unsupported project üìÖ

This is a proof of concept. The code is not robust against failure, the error
handling is incomplete. We do not expect it to be operable in production as-is.

# Project

## service

The [`/service`](service) subproject is a CloudFormation template that deploys
the following resources:

* An EventBridge rule for "Build Finished" events
* An SQS Queue to store the "Build Finished" events
* An API Gateway to provide an HTTP facade over the SQS Queue

The following parameters are required to deploy the service:

* `EventBridgeBusName`, the name of the EventBridge Bus you have [configured](https://buildkite.com/docs/integrations/amazon-eventbridge#configuring) your Buildkite Partner Event Source to deliver events to

The following outputs are generated by the deployed stack:

* `Queue`, the SQS Queue ARN
* `QueueUrl`, the SQS Queue URL
* `ApiUrl`, the API Gateway URL for providing to the [worker](#worker) configuration

## worker

The [`/worker`](worker) is a nodejs program which retrieves messages from the
[service](#service) and applies GitHub Commit Statuses in a loop.

The worker requires the following configuration as environment variables:

* `API_KEY`, an API Key associated with the API Gateway.
* `API_URL`, the value of the `ApiUrl` from the service outputs.
* `GITHUB_URL`, the URL of your GitHub Enterprise instance‚Äôs API e.g. https://buildkite-ghe.com/api/v3
* `GITHUB_ACCESS_TOKEN`, a personal access token with `repo` scope and access to the repositories you want to post commit statuses to on the GitHub Enterprise instance in `GITHUB_URL`
